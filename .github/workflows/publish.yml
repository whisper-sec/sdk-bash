# Whisper API CLI - Bash CLI Publish Pipeline
# Publishes CLI to GitHub Releases
# Auto-generated by OpenAPI Generator

name: Publish

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  publish:
    name: Publish CLI to GitHub Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        run: |
          VERSION=${{ github.ref_name }}
          VERSION=${VERSION#v}  # Remove 'v' prefix if present
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=${{ github.ref_name }}" >> $GITHUB_OUTPUT

      - name: Make CLI executable
        run: chmod +x whisper-api-cli

      - name: Create distribution packages
        run: |
          mkdir -p dist

          # Copy files
          cp whisper-api-cli dist/
          cp README.md dist/ || echo "No README found"
          cp LICENSE* dist/LICENSE || echo "No LICENSE found"

          # Create tar.gz archive
          cd dist
          tar -czf whisper-api-cli-${{ steps.version.outputs.version }}.tar.gz whisper-api-cli README.md LICENSE 2>/dev/null || tar -czf whisper-api-cli-${{ steps.version.outputs.version }}.tar.gz whisper-api-cli README.md

          # Create zip archive (for Windows users)
          zip -q whisper-api-cli-${{ steps.version.outputs.version }}.zip whisper-api-cli README.md LICENSE 2>/dev/null || zip -q whisper-api-cli-${{ steps.version.outputs.version }}.zip whisper-api-cli README.md

          # Create install script
          cd ..
          cat > dist/install.sh << 'INSTALL_SCRIPT'
          #!/bin/bash
          set -e

          REPO="${{ github.repository }}"
          VERSION="${{ steps.version.outputs.tag }}"
          CLI_NAME="whisper-api-cli"
          INSTALL_DIR="${INSTALL_DIR:-/usr/local/bin}"

          echo "📦 Installing $CLI_NAME $VERSION..."

          # Detect OS
          OS="$(uname -s)"
          case "$OS" in
            Linux*|Darwin*)
              ;;
            *)
              echo "❌ Unsupported OS: $OS"
              exit 1
              ;;
          esac

          # Download and install
          DOWNLOAD_URL="https://github.com/$REPO/releases/download/$VERSION/$CLI_NAME-${{ steps.version.outputs.version }}.tar.gz"
          echo "⬇️  Downloading from $DOWNLOAD_URL..."

          TMP_DIR=$(mktemp -d)
          cd "$TMP_DIR"

          if command -v curl >/dev/null 2>&1; then
            curl -fsSL "$DOWNLOAD_URL" -o "$CLI_NAME.tar.gz"
          elif command -v wget >/dev/null 2>&1; then
            wget -q "$DOWNLOAD_URL" -O "$CLI_NAME.tar.gz"
          else
            echo "❌ Neither curl nor wget found. Please install one of them."
            exit 1
          fi

          tar -xzf "$CLI_NAME.tar.gz"
          chmod +x "$CLI_NAME"

          # Install
          if [ -w "$INSTALL_DIR" ]; then
            mv "$CLI_NAME" "$INSTALL_DIR/"
          else
            echo "🔐 Installing to $INSTALL_DIR (requires sudo)..."
            sudo mv "$CLI_NAME" "$INSTALL_DIR/"
          fi

          cd - >/dev/null
          rm -rf "$TMP_DIR"

          echo "✅ $CLI_NAME installed to $INSTALL_DIR/$CLI_NAME"
          echo ""
          echo "Run '$CLI_NAME -h' to get started!"
          INSTALL_SCRIPT

          chmod +x dist/install.sh

      - name: Generate checksums
        run: |
          cd dist
          sha256sum whisper-api-cli-*.tar.gz whisper-api-cli-*.zip > SHA256SUMS
          cd ..

      - name: Create Homebrew formula
        run: |
          VERSION=${{ steps.version.outputs.version }}
          TAR_URL="https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.tag }}/whisper-api-cli-$VERSION.tar.gz"
          SHA256=$(sha256sum dist/whisper-api-cli-$VERSION.tar.gz | cut -d' ' -f1)

          # Convert script name to Ruby class name (CamelCase, no hyphens)
          CLASS_NAME=$(echo "whisper-api-cli" | sed 's/-/ /g' | awk '{for(i=1;i<=NF;i++) $i=toupper(substr($i,1,1)) tolower(substr($i,2))}1' | sed 's/ //g')

          mkdir -p dist/homebrew
          cat > dist/homebrew/whisper-api-cli.rb << FORMULA
          class $CLASS_NAME < Formula
            desc "{{appDescription}}"
            homepage "https://github.com/${{ github.repository }}"
            url "$TAR_URL"
            sha256 "$SHA256"
            version "$VERSION"
            license "MIT"

            def install
              bin.install "whisper-api-cli"
            end

            test do
              system "#{bin}/whisper-api-cli", "-h"
            end
          end
          FORMULA

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            dist/whisper-api-cli-${{ steps.version.outputs.version }}.tar.gz
            dist/whisper-api-cli-${{ steps.version.outputs.version }}.zip
            dist/install.sh
            dist/SHA256SUMS
            dist/homebrew/whisper-api-cli.rb
          body: |
            ## 🚀 Whisper API CLI ${{ steps.version.outputs.tag }}

            ### 📥 Installation Methods

            #### Quick Install (Recommended)
            ```bash
            curl -fsSL https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.tag }}/install.sh | bash
            ```

            #### Homebrew (macOS/Linux)
            ```bash
            # Add tap (first time only)
            brew tap whisper-sec/tap https://github.com/whisper-sec/homebrew-tap

            # Install
            brew install whisper-api-cli
            ```

            #### Manual Installation
            ```bash
            # Download and extract
            curl -fsSL https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.tag }}/whisper-api-cli-${{ steps.version.outputs.version }}.tar.gz | tar xz

            # Make executable and move to PATH
            chmod +x whisper-api-cli
            sudo mv whisper-api-cli /usr/local/bin/
            ```

            #### Download Directly
            - [Linux/macOS (tar.gz)](https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.tag }}/whisper-api-cli-${{ steps.version.outputs.version }}.tar.gz)
            - [Windows (zip)](https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.tag }}/whisper-api-cli-${{ steps.version.outputs.version }}.zip)
            - [Install Script](https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.tag }}/install.sh)
            - [Homebrew Formula](https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.tag }}/whisper-api-cli.rb)

            ### ✅ Verify Installation
            ```bash
            whisper-api-cli -h
            whisper-api-cli --version
            ```

            ### 🔐 Checksums
            See [SHA256SUMS](https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.tag }}/SHA256SUMS) for file verification.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
