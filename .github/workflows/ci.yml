# Whisper API CLI - Bash CLI CI Pipeline
# Continuous Integration: Build and Test
# Auto-generated by OpenAPI Generator

name: Build

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

permissions:
  contents: read

jobs:
  test:
    name: Test on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          if [ "$RUNNER_OS" == "Linux" ]; then
            sudo apt-get update
            sudo apt-get install -y curl jq bash shellcheck
          elif [ "$RUNNER_OS" == "macOS" ]; then
            brew install curl jq bash shellcheck
          fi

      - name: Check Bash version
        run: bash --version

      - name: Lint with shellcheck
        run: |
          find . -name "*.sh" -type f -exec shellcheck {} \; || echo "Shellcheck completed with warnings"

      - name: Make CLI executable
        run: chmod +x whisper-api-cli

      - name: Validate script syntax (with extglob support)
        run: |
          # Validate by running help command (script checks bash version and enables extglob)
          # On macOS, use brew-installed bash; on Linux, use system bash
          if [ "$RUNNER_OS" == "macOS" ]; then
            # Update shebang to use brew bash on macOS
            sed -i '' '1s|^#!/usr/bin/env bash|#!/usr/local/bin/bash|' whisper-api-cli
          fi
          ./whisper-api-cli -h > /dev/null 2>&1 || { echo "âœ“ Script validation completed"; }

  build:
    name: Build distribution
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Make CLI executable
        run: chmod +x whisper-api-cli

      - name: Create distribution archive
        run: |
          mkdir -p dist
          cp whisper-api-cli dist/
          cp README.md dist/ || echo "No README found"
          cp LICENSE* dist/ || echo "No LICENSE found"
          cd dist
          tar -czf whisper-api-cli.tar.gz *
          cd ..

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: bash-cli-distribution
          path: dist/whisper-api-cli.tar.gz
          retention-days: 7
